# language: ko
@exception
기능: 대기열 상태 조회 예외 처리
  사용자가 현재 대기열 상태를 조회할 때 발생할 수 있는 예외 상황을 처리한다
  WAITING, READY, ACTIVE 상태를 구분하여 반환한다

  배경:
    Given 예약 가능한 콘서트가 존재한다

  # ==========================================
  # 정상 케이스 (WAITING)
  # ==========================================

  @status @happy
  시나리오: WAITING 상태 사용자가 현재 상태를 확인한다
    Given 사용자가 이미 대기열에 진입했다
    And 현재 WAITING 상태이다
    When 상태 조회 API를 호출한다
    Then 상태가 "WAITING"이다
    And 대기 순번이 표시된다

  # ==========================================
  # 정상 케이스 (READY)
  # ==========================================

  @status @happy
  시나리오: READY 상태 사용자가 현재 상태를 확인한다
    Given 사용자가 이미 대기열에 진입했다
    And 스케줄러에 의해 입장이 허가되었다
    And READY 상태이다
    When 상태 조회 API를 호출한다
    Then 상태가 "READY"이다
    And 만료 시간이 표시된다

  # ==========================================
  # 정상 케이스 (ACTIVE)
  # ==========================================

  @status @happy
  시나리오: ACTIVE 상태 사용자가 현재 상태를 확인한다
    Given 사용자가 이미 대기열에 진입했다
    And 입장이 허가되었다
    And 예매 페이지에 접속하여 ACTIVE 상태이다
    When 상태 조회 API를 호출한다
    Then 상태가 "ACTIVE"이다
    And 만료 시간이 표시된다

  # ==========================================
  # 토큰 없음
  # ==========================================

  @status @exception
  시나리오: 대기열에 진입하지 않은 사용자가 상태를 조회한다
    Given 대기열에 등록하지 않은 사용자이다
    When 상태 조회 API를 호출한다
    Then 조회가 실패한다
    And 대기열 토큰을 찾을 수 없다는 메시지가 반환된다

  # ==========================================
  # 토큰 만료
  # ==========================================

  @status @exception
  시나리오: 만료된 토큰을 가진 사용자가 상태를 조회한다
    Given 사용자가 이미 대기열에 진입했다
    And 예매 페이지에 접속하여 ACTIVE 상태였다
    And 10분이 경과하여 토큰이 만료되었다
    When 상태 조회 API를 호출한다
    Then 상태가 "EXPIRED"이다

  # ==========================================
  # Validation 실패
  # ==========================================

  @status @validation
  시나리오: 콘서트 ID 없이 상태를 조회한다
    Given 사용자가 이미 대기열에 진입했다
    When 콘서트 ID 없이 상태 조회를 시도한다
    Then 요청이 거부된다
    And 필수 파라미터가 누락되었다는 메시지가 반환된다

  @status @validation
  시나리오: 사용자 ID 없이 상태를 조회한다
    Given 사용자가 이미 대기열에 진입했다
    When 사용자 ID 없이 상태 조회를 시도한다
    Then 요청이 거부된다
    And 필수 파라미터가 누락되었다는 메시지가 반환된다

  @status @validation
  시나리오: 빈 콘서트 ID로 상태를 조회한다
    Given 사용자가 이미 대기열에 진입했다
    When 빈 콘서트 ID로 상태 조회를 시도한다
    Then 요청이 거부된다
    And 잘못된 입력값이라는 메시지가 반환된다

  # ==========================================
  # 순번 변경 확인
  # ==========================================

  @status @polling
  시나리오: 대기 중 순번이 변경된 것을 확인한다
    Given 사용자가 이미 대기열에 진입했다
    And 현재 WAITING 상태이다
    And 현재 대기 순번이 부여되어 있다
    And 일부 사용자가 예매를 완료하여 이탈했다
    When 상태 조회 API를 호출한다
    Then 순번이 앞당겨진 것을 확인할 수 있다

  # ==========================================
  # 상태 전환 확인
  # ==========================================

  @status @transition
  시나리오: WAITING 상태에서 READY 상태로 전환된 것을 확인한다
    Given 사용자가 이미 대기열에 진입했다
    And 현재 WAITING 상태이다
    When 대기열이 전환된다
    And 상태 조회 API를 호출한다
    Then 상태가 "READY"이다
    And 토큰이 반환된다

  # ==========================================
  # 부하 테스트
  # ==========================================

  @status @performance
  시나리오: 대량의 사용자가 동시에 상태를 조회한다
    Given 많은 사용자가 대기열에 등록한 상태이다
    When 모든 사용자가 동시에 상태 조회를 시도한다
    Then 모든 요청이 빠르게 처리된다
    And 각 사용자는 자신의 순번을 정확히 확인할 수 있다
