# language: ko
@exception
기능: READY → ACTIVE 전환 예외 처리
  입장이 허가된 사용자가 예매 페이지에 접속할 때 발생할 수 있는 예외 상황을 처리한다
  READY 상태(TTL 5분) → ACTIVE 상태(TTL 10분)로 전환

  배경:
    Given 예약 가능한 콘서트가 존재한다
    And 입장 허가 토큰 유효 시간은 5분이다
    And 활성 토큰 유효 시간은 10분이다

  # ==========================================
  # 정상 케이스
  # ==========================================

  @activate @happy
  시나리오: 입장 허가된 사용자가 예매 페이지에 접속한다
    Given 사용자가 이미 대기열에 진입했다
    And 스케줄러에 의해 입장이 허가되었다
    And READY 상태이다
    And 입장 허가 토큰(TTL 5분)을 보유하고 있다
    When 예매 페이지에 접속한다
    Then 예매 페이지 접속이 완료된다
    And ACTIVE 상태로 전환된다
    And 토큰 유효 시간이 10분으로 연장된다

  # ==========================================
  # 순번 미도달 (아직 WAITING)
  # ==========================================

  @activate @exception
  시나리오: 아직 입장이 허가되지 않은 사용자가 접속을 시도한다
    Given 사용자가 이미 대기열에 진입했다
    And 현재 WAITING 상태이다
    When 예매 페이지에 접속을 시도한다
    Then 접속이 거부된다
    And 유효하지 않은 토큰이라는 메시지가 반환된다

  # ==========================================
  # 토큰 만료
  # ==========================================

  @activate @exception
  시나리오: 만료된 입장 허가 토큰으로 접속을 시도한다
    Given 사용자가 이미 대기열에 진입했다
    And 입장이 허가되었다
    And 입장 허가 토큰이 발급되었다
    And 5분이 경과하여 토큰이 만료되었다
    When 예매 페이지에 접속을 시도한다
    Then 접속이 거부된다
    And 대기열 순번이 만료되었다는 메시지가 반환된다

  # ==========================================
  # 토큰 없음
  # ==========================================

  @activate @exception
  시나리오: 대기열에 진입하지 않은 사용자가 접속을 시도한다
    Given 대기열에 등록하지 않은 사용자이다
    When 예매 페이지에 접속을 시도한다
    Then 접속이 거부된다
    And 대기열 토큰을 찾을 수 없다는 메시지가 반환된다

  # ==========================================
  # Idempotency
  # ==========================================

  @activate @idempotency
  시나리오: 이미 ACTIVE 상태인 사용자가 다시 접속을 시도한다
    Given 사용자가 이미 대기열에 진입했다
    And 입장이 허가되었다
    And 예매 페이지에 접속하여 ACTIVE 상태이다
    When 예매 페이지에 다시 접속을 시도한다
    Then 예매 페이지 접속이 완료된다
    And ACTIVE 상태가 유지된다
    And 기존 토큰이 그대로 유지된다

  # ==========================================
  # Validation 실패
  # ==========================================

  @activate @validation
  시나리오: 콘서트 ID 없이 접속을 시도한다
    Given 사용자가 이미 대기열에 진입했다
    When 콘서트 ID 없이 접속을 시도한다
    Then 요청이 거부된다
    And 잘못된 입력값이라는 메시지가 반환된다

  @activate @validation
  시나리오: 사용자 ID 없이 접속을 시도한다
    Given 사용자가 이미 대기열에 진입했다
    When 사용자 ID 없이 접속을 시도한다
    Then 요청이 거부된다
    And 잘못된 입력값이라는 메시지가 반환된다
