# language: ko
@concurrent
기능: 동시성 예외 처리
  여러 사용자 또는 같은 사용자의 동시 요청 시 발생할 수 있는 예외 상황을 처리한다
  WAITING → READY → ACTIVE 상태에서 발생하는 동시성 제어를 검증한다

  배경:
    Given 예약 가능한 콘서트가 존재한다

  # ==========================================
  # 여러 디바이스 동시 진입
  # ==========================================

  @concurrent @enter @idempotency
  시나리오: 사용자가 여러 디바이스에서 동시에 진입을 시도한다
    Given 대기열 진입을 위한 새로운 사용자가 준비된다
    When 여러 디바이스에서 동시에 대기열 등록을 요청한다
    Then 모든 요청이 성공한다
    And 모든 응답의 대기 순번이 동일하다
    And 신규 진입은 하나만 표시된다
    And 대기열에는 하나의 엔트리만 존재한다

  # ==========================================
  # 네트워크 지연 중복 요청
  # ==========================================

  @concurrent @enter @retry
  시나리오: 사용자가 응답 지연으로 재시도한다
    Given 사용자가 이미 대기열에 진입했다
    When 대기열 재진입을 요청한다
    Then 대기열 진입 요청이 승인된다
    And 기존 대기 순번이 그대로 유지된다

  # ==========================================
  # 대량 동시 진입
  # ==========================================

  @concurrent @enter @performance
  시나리오: 대량의 사용자가 동시에 진입을 시도한다
    Given 콘서트 판매가 시작되었다
    When 100명의 사용자가 동시에 진입 API를 호출한다
    Then 모든 사용자가 대기열에 추가된다
    And 각 사용자는 고유한 순번을 받는다

  # ==========================================
  # 동시 활성화
  # ==========================================

  @concurrent @activate @idempotency
  시나리오: 사용자가 여러 번 활성화를 시도한다
    Given 사용자가 이미 대기열에 진입했다
    And 입장이 허가되어 READY 상태이다
    When 동시에 여러 번 예매 페이지 접속을 시도한다
    Then 모든 요청이 성공한다
    And ACTIVE 상태로 전환된다
    And 모든 응답의 토큰이 동일하다

  # ==========================================
  # 동시 연장 (한도 직전)
  # ==========================================

  @concurrent @extend @critical
  시나리오: 사용자가 연장 한도 직전에 동시에 여러 번 연장을 시도한다
    Given 사용자가 이미 대기열에 진입했다
    And 예매 페이지에 접속하여 ACTIVE 상태이다
    And 이미 1회 연장했다
    When 동시에 여러 번 시간 연장을 요청한다
    Then 최종 연장 횟수는 2회를 초과하지 않는다

  # ==========================================
  # 동시 검증
  # ==========================================

  @concurrent @validate
  시나리오: 사용자가 같은 토큰으로 동시에 여러 번 검증을 시도한다
    Given 사용자가 이미 대기열에 진입했다
    And 예매 페이지에 접속하여 ACTIVE 상태이다
    When 동시에 여러 번 토큰 유효성을 확인한다
    Then 모든 검증이 성공한다
    And 토큰 상태는 변경되지 않는다

  # ==========================================
  # 대량 상태 조회
  # ==========================================

  @concurrent @status @performance
  시나리오: 여러 사용자가 동시에 상태를 조회한다
    Given 많은 사용자가 대기열에 등록한 상태이다
    When 모든 사용자가 동시에 상태 조회를 시도한다
    Then 모든 요청이 빠르게 처리된다
    And 각 사용자는 자신의 순번을 정확히 받는다

  # ==========================================
  # 전환 중 조회 (원자성 검증) - @wip 처리
  # ==========================================

  @wip @concurrent @edge @atomicity
  시나리오: 전환 완료 전에 조회하면 이전 상태를 받는다
    Given 사용자가 WAITING 상태이다
    And 스케줄러가 사용자를 READY로 전환 중이다
    When 전환이 커밋되기 전에 상태를 조회한다
    Then 상태가 "WAITING"이다

  @wip @concurrent @edge @atomicity
  시나리오: 전환 완료 후에 조회하면 새로운 상태를 받는다
    Given 사용자가 WAITING 상태였다
    And 스케줄러가 사용자를 READY로 전환했다
    When 전환이 커밋된 후에 상태를 조회한다
    Then 상태가 "READY"이다
    And 토큰이 반환된다
