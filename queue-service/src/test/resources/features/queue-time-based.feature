# language: ko
@time
기능: 시간 기반 예외 처리
  토큰의 시간 제한(TTL)과 관련된 예외 상황을 처리한다
  READY 상태(TTL 5분) → ACTIVE 상태(TTL 10분)

  배경:
    Given 예약 가능한 콘서트가 존재한다
    And 입장 허가 토큰 유효 시간은 5분이다
    And 활성 토큰 유효 시간은 10분이다

  # ==========================================
  # READY 토큰 만료 (TTL 5분)
  # ==========================================

  @time @exception
  시나리오: READY 상태에서 토큰이 만료되면 접속이 거부된다
    Given 사용자가 이미 대기열에 진입했다
    And 스케줄러에 의해 입장이 허가되었다
    And READY 상태이다
    And 입장 허가 토큰이 발급되었다
    When 토큰이 강제 만료된다
    And 예매 페이지에 접속을 시도한다
    Then 접속이 거부된다
    And 대기열 순번이 만료되었다는 메시지가 반환된다

  # ==========================================
  # ACTIVE 토큰 만료 (TTL 10분)
  # ==========================================

  @time @exception
  시나리오: ACTIVE 상태에서 토큰이 만료되면 검증이 실패한다
    Given 사용자가 이미 대기열에 진입했다
    And 입장이 허가되었다
    And 예매 페이지에 접속하여 ACTIVE 상태이다
    When 토큰이 강제 만료된다
    And 토큰 유효성 검증을 요청한다
    Then 검증이 실패한다
    And 대기열 순번이 만료되었다는 메시지가 반환된다

  # ==========================================
  # 연장을 통한 시간 확보
  # ==========================================

  @time @extend
  시나리오: ACTIVE 상태에서 연장하면 토큰이 유효하다
    Given 사용자가 이미 대기열에 진입했다
    And 예매 페이지에 접속하여 ACTIVE 상태이다
    And 시간 연장을 한 적이 없다
    When 토큰 연장 API를 호출한다
    Then 토큰 연장이 성공한다
    And 만료 시간이 갱신된다

  # ==========================================
  # 2회 연장 후 추가 연장 거부
  # ==========================================

  @time @extend @exception
  시나리오: 2회 연장 후에는 더 이상 연장할 수 없다
    Given 사용자가 이미 대기열에 진입했다
    And 예매 페이지에 접속하여 ACTIVE 상태이다
    And 이미 2회 연장했다
    When 토큰 연장 API를 호출한다
    Then 접속이 거부된다
    And 더 이상 연장할 수 없다는 메시지가 반환된다

  # ==========================================
  # READY → ACTIVE 전환 시 TTL 리셋
  # ==========================================

  @time @activate
  시나리오: READY 상태에서 ACTIVE로 전환하면 TTL이 갱신된다
    Given 사용자가 이미 대기열에 진입했다
    And 입장이 허가되어 READY 상태이다
    And 입장 허가 토큰이 발급되었다
    When 예매 페이지에 접속한다
    Then 예매 페이지 접속이 완료된다
    And ACTIVE 상태로 전환된다
    And 토큰 유효 시간이 10분으로 연장된다

  # ==========================================
  # 만료 후 재진입
  # ==========================================

  @time @reenter
  시나리오: 만료 후 다시 대기열에 진입할 수 있다
    Given 사용자가 이미 대기열에 진입했다
    And 예매 페이지에 접속하여 ACTIVE 상태였다
    And 토큰이 강제 만료된다
    When 대기열 재진입을 요청한다
    Then 대기열 진입 요청이 승인된다
    And 신규 진입으로 표시된다
