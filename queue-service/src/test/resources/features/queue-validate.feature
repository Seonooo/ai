# language: ko
@exception
기능: 토큰 검증 예외 처리
  예매 API 호출 시 사용자의 토큰이 유효한지 검증할 때 발생할 수 있는 예외 상황을 처리한다
  ACTIVE 상태 사용자만 검증을 통과할 수 있다

  배경:
    Given 예약 가능한 콘서트가 존재한다

  # ==========================================
  # 정상 케이스
  # ==========================================

  @validate @happy
  시나리오: 예매 중인 사용자의 토큰이 유효한지 확인한다
    Given 사용자가 이미 대기열에 진입했다
    And 입장이 허가되었다
    And 예매 페이지에 접속하여 ACTIVE 상태이다
    When 토큰 유효성 검증을 요청한다
    Then 검증된 토큰은 유효하다

  # ==========================================
  # 토큰 값 불일치 (핵심 예외)
  # ==========================================

  @validate @exception @critical
  시나리오: 잘못된 토큰 값으로 검증을 시도한다
    Given 사용자가 이미 대기열에 진입했다
    And 입장이 허가되었다
    And 예매 페이지에 접속하여 ACTIVE 상태이다
    When 잘못된 토큰으로 유효성을 확인한다
    Then 검증이 실패한다
    And 유효하지 않은 토큰이라는 메시지가 반환된다

  # ==========================================
  # 토큰 만료
  # ==========================================

  @validate @exception
  시나리오: 만료된 토큰으로 검증을 시도한다
    Given 사용자가 이미 대기열에 진입했다
    And 입장이 허가되었다
    And 예매 페이지에 접속하여 ACTIVE 상태였다
    And 10분이 경과하여 토큰이 만료되었다
    When 토큰 유효성 검증을 요청한다
    Then 검증이 실패한다
    And 대기열 순번이 만료되었다는 메시지가 반환된다

  # ==========================================
  # null/빈 토큰
  # ==========================================

  @validate @exception
  시나리오: 토큰 없이 검증을 시도한다
    Given 사용자가 이미 대기열에 진입했다
    And 예매 페이지에 접속하여 ACTIVE 상태이다
    When 토큰 없이 유효성 확인을 시도한다
    Then 검증이 실패한다
    And 유효하지 않은 토큰이라는 메시지가 반환된다

  # ==========================================
  # 비활성 상태 (WAITING, READY)
  # ==========================================

  @validate @exception
  시나리오: WAITING 상태 사용자가 검증을 시도한다
    Given 사용자가 이미 대기열에 진입했다
    And 아직 WAITING 상태이다
    When 토큰 유효성 검증을 요청한다
    Then 검증이 실패한다
    And 유효하지 않은 토큰이라는 메시지가 반환된다

  @validate @exception
  시나리오: READY 상태 사용자가 검증을 시도한다
    Given 사용자가 이미 대기열에 진입했다
    And 입장이 허가되어 READY 상태이다
    And 아직 예매 페이지에 접속하지 않았다
    When 토큰 유효성 검증을 요청한다
    Then 검증이 실패한다
    And 유효하지 않은 토큰이라는 메시지가 반환된다

  # ==========================================
  # 토큰 없음
  # ==========================================

  @validate @exception
  시나리오: 대기열에 진입하지 않은 사용자가 검증을 시도한다
    Given 대기열에 등록하지 않은 사용자이다
    When 토큰 유효성 검증을 요청한다
    Then 검증이 실패한다
    And 대기열 토큰을 찾을 수 없다는 메시지가 반환된다

  # ==========================================
  # Validation 실패
  # ==========================================

  @validate @validation
  시나리오: 빈 토큰 값으로 검증을 시도한다
    Given 예매 페이지에 접속하여 ACTIVE 상태이다
    When 빈 토큰 값으로 유효성 확인을 시도한다
    Then 요청이 거부된다
    And 잘못된 입력값이라는 메시지가 반환된다

  # ==========================================
  # 연속 검증
  # ==========================================

  @validate @performance
  시나리오: 예매 진행 중 여러 번 검증을 시도한다
    Given 사용자가 이미 대기열에 진입했다
    And 입장이 허가되었다
    And 예매 페이지에 접속하여 ACTIVE 상태이다
    When 여러 번 토큰 유효성을 확인한다
    Then 모든 검증이 성공한다
    And 토큰 상태는 변경되지 않는다

  # ==========================================
  # 보안 검증 (Cross-Check)
  # ==========================================

  @validate @security
  시나리오: 타인의 토큰으로 검증을 시도한다
    Given 예매 페이지에 접속하여 ACTIVE 상태이다
    And 다른 사용자로 변경한다
    When 토큰 유효성 검증을 요청한다
    Then 검증이 실패한다
    And 유효하지 않은 토큰이라는 메시지가 반환된다

  @validate @security
  시나리오: 다른 콘서트의 토큰으로 검증을 시도한다
    Given 예매 페이지에 접속하여 ACTIVE 상태이다
    And 다른 콘서트로 변경한다
    When 토큰 유효성 검증을 요청한다
    Then 검증이 실패한다
    And 유효하지 않은 토큰이라는 메시지가 반환된다
