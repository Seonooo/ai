# language: ko
@exception
기능: 대기열 진입 예외 처리
  콘서트 예매를 위한 대기열 진입 시 발생할 수 있는 예외 상황을 처리한다

  배경:
    Given 예약 가능한 콘서트가 존재한다

  # ==========================================
  # 정상 케이스
  # ==========================================

  @enter @happy
  시나리오: 신규 사용자가 대기열에 진입한다
    Given 대기열 진입을 위한 새로운 사용자가 준비된다
    When 대기열 진입을 요청한다
    Then 대기열 진입 요청이 승인된다
    And 신규 진입으로 표시된다
    And 상태는 WAITING이다
    And 나의 대기 순번을 확인할 수 있다

  # ==========================================
  # 중복 진입 (Idempotency)
  # ==========================================

  @enter @idempotency
  시나리오: 이미 대기 중인 사용자가 다시 진입을 시도한다
    Given 사용자가 이미 대기열에 진입했다
    And 현재 WAITING 상태이다
    And 현재 대기 순번이 부여되어 있다
    When 대기열 재진입을 요청한다
    Then 대기열 진입 요청이 승인된다
    And 기존 진입으로 표시된다
    And 기존 대기 순번이 그대로 유지된다
    And 새로운 대기열 엔트리가 생성되지 않는다

  @enter @idempotency
  시나리오: 입장 허가된 사용자가 다시 진입을 시도한다
    Given 사용자가 이미 대기열에 진입했다
    And 입장이 허가되어 READY 상태이다
    And 유효한 입장 허가 토큰을 보유하고 있다
    When 대기열 재진입을 요청한다
    Then 대기열 진입 요청이 승인된다
    And 기존 진입으로 표시된다
    And READY 상태가 그대로 유지된다
    And 기존 토큰이 반환된다

  @enter @idempotency
  시나리오: 예매 진행 중인 사용자가 다시 진입을 시도한다
    Given 사용자가 이미 대기열에 진입했다
    And 예매 페이지에 접속하여 ACTIVE 상태이다
    And 유효한 활성 토큰을 보유하고 있다
    When 대기열 재진입을 요청한다
    Then 대기열 진입 요청이 승인된다
    And 기존 진입으로 표시된다
    And ACTIVE 상태가 그대로 유지된다
    And 기존 토큰이 반환된다

  # ==========================================
  # Validation 실패
  # ==========================================

  @enter @validation
  시나리오: 콘서트 ID 없이 진입을 시도한다
    Given 대기열 진입을 위한 새로운 사용자가 준비된다
    When 콘서트 ID 없이 대기열 등록을 요청한다
    Then 요청이 거부된다
    And 잘못된 입력값이라는 메시지가 반환된다

  @enter @validation
  시나리오: 사용자 ID 없이 진입을 시도한다
    Given 대기열 진입을 위한 새로운 사용자가 준비된다
    When 사용자 ID 없이 대기열 등록을 요청한다
    Then 요청이 거부된다
    And 잘못된 입력값이라는 메시지가 반환된다

  # ==========================================
  # 동시성
  # ==========================================

  @enter @concurrent
  시나리오: 같은 사용자가 여러 디바이스에서 동시에 진입을 시도한다
    Given 대기열 진입을 위한 새로운 사용자가 준비된다
    When 여러 디바이스에서 동시에 대기열 등록을 요청한다
    Then 모든 요청이 성공한다
    And 모든 응답의 대기 순번이 동일하다
    And 대기열에는 하나의 엔트리만 존재한다
