# language: ko
@exception
기능: 토큰 연장 예외 처리
  예매 진행 중 시간이 부족한 사용자가 토큰을 연장할 때 발생할 수 있는 예외 상황을 처리한다
  ACTIVE 상태에서만 연장 가능하며, 최대 2회까지 허용된다

  배경:
    Given 예약 가능한 콘서트가 존재한다
    And 활성 토큰 유효 시간은 10분이다
    And 최대 연장 횟수는 2회이다

  # ==========================================
  # 정상 케이스
  # ==========================================

  @extend @happy
  시나리오: 예매 중인 사용자가 첫 번째 시간 연장을 요청한다
    Given 사용자가 이미 대기열에 진입했다
    And 입장이 허가되었다
    And 예매 페이지에 접속하여 ACTIVE 상태이다
    And 시간 연장을 한 적이 없다
    When 토큰 연장 API를 호출한다
    Then 토큰 연장이 성공한다
    And 연장 횟수가 1이다
    And 만료 시간이 갱신된다

  @extend @happy
  시나리오: 예매 중인 사용자가 두 번째 시간 연장을 요청한다
    Given 사용자가 이미 대기열에 진입했다
    And 입장이 허가되었다
    And 예매 페이지에 접속하여 ACTIVE 상태이다
    And 이미 1회 연장했다
    When 토큰 연장 API를 호출한다
    Then 토큰 연장이 성공한다
    And 연장 횟수가 2이다
    And 만료 시간이 갱신된다

  # ==========================================
  # 연장 한도 초과 (핵심 예외)
  # ==========================================

  @extend @exception @critical
  시나리오: 이미 2회 연장한 사용자가 세 번째 연장을 시도한다
    Given 사용자가 이미 대기열에 진입했다
    And 입장이 허가되었다
    And 예매 페이지에 접속하여 ACTIVE 상태이다
    And 이미 2회 연장했다
    When 토큰 연장 API를 호출한다
    Then 접속이 거부된다
    And 더 이상 연장할 수 없다는 메시지가 반환된다

  # ==========================================
  # 토큰 만료
  # ==========================================

  @extend @exception
  시나리오: 만료된 토큰을 연장하려고 시도한다
    Given 사용자가 이미 대기열에 진입했다
    And 입장이 허가되었다
    And 예매 페이지에 접속하여 ACTIVE 상태였다
    And 10분이 경과하여 토큰이 만료되었다
    When 토큰 연장 API를 호출한다
    Then 접속이 거부된다
    And 대기열 순번이 만료되었다는 메시지가 반환된다

  # ==========================================
  # 비활성 상태 (WAITING, READY)
  # ==========================================

  @extend @exception
  시나리오: WAITING 상태 사용자가 연장을 시도한다
    Given 사용자가 이미 대기열에 진입했다
    And 현재 WAITING 상태이다
    When 토큰 연장 API를 호출한다
    Then 접속이 거부된다
    And 유효하지 않은 토큰이라는 메시지가 반환된다

  @extend @exception
  시나리오: READY 상태 사용자가 연장을 시도한다
    Given 사용자가 이미 대기열에 진입했다
    And 입장이 허가되어 READY 상태이다
    And 아직 예매 페이지에 접속하지 않았다
    When 토큰 연장 API를 호출한다
    Then 접속이 거부된다
    And 유효하지 않은 토큰이라는 메시지가 반환된다

  # ==========================================
  # 토큰 없음
  # ==========================================

  @extend @exception
  시나리오: 대기열에 진입하지 않은 사용자가 연장을 시도한다
    Given 대기열에 등록하지 않은 사용자이다
    When 토큰 연장 API를 호출한다
    Then 접속이 거부된다
    And 대기열 토큰을 찾을 수 없다는 메시지가 반환된다

  # ==========================================
  # Validation 실패
  # ==========================================

  @extend @validation
  시나리오: 콘서트 ID 없이 연장을 시도한다
    Given 예매 페이지에 접속하여 ACTIVE 상태이다
    When 콘서트 ID 없이 시간 연장을 요청한다
    Then 요청이 거부된다
    And 잘못된 입력값이라는 메시지가 반환된다

  # ==========================================
  # 동시성
  # ==========================================

  @extend @concurrent
  시나리오: 연장 한도 직전에 동시에 여러 번 연장을 시도한다
    Given 사용자가 이미 대기열에 진입했다
    And 예매 페이지에 접속하여 ACTIVE 상태이다
    And 이미 1회 연장했다
    When 동시에 여러 번 시간 연장을 요청한다
    Then 최종 연장 횟수는 2회를 초과하지 않는다
