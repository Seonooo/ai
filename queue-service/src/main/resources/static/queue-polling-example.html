<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>ëŒ€ê¸°ì—´ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì˜ˆì œ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
            background-color: #f8f9fa;
        }
        .status.waiting {
            background-color: #fff3cd;
            border-left: 5px solid #ffc107;
        }
        .status.ready {
            background-color: #d1ecf1;
            border-left: 5px solid #17a2b8;
        }
        .status.active {
            background-color: #d4edda;
            border-left: 5px solid #28a745;
        }
        .button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .button:hover {
            background-color: #0056b3;
        }
        .button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .log {
            background-color: #f8f9fa;
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
        }
        .log-entry.info {
            color: #0056b3;
        }
        .log-entry.success {
            color: #28a745;
        }
        .log-entry.error {
            color: #dc3545;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>ğŸ« ëŒ€ê¸°ì—´ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§</h1>

    <div>
        <label>ì½˜ì„œíŠ¸ ID:</label>
        <input id="concertId" style="margin: 10px 0; padding: 5px; width: 200px;" type="text" value="CONCERT-001">
        <br>
        <label>ì‚¬ìš©ì ID:</label>
        <input id="userId" style="margin: 10px 0; padding: 5px; width: 200px;" type="text" value="USER-001">
    </div>

    <button class="button" id="enterBtn" onclick="enterQueue()">ëŒ€ê¸°ì—´ ì§„ì…</button>
    <button class="button" disabled id="sseBtn" onclick="startSSE()">ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì‹œì‘</button>
    <button class="button" disabled id="stopBtn" onclick="stopSSE()">ëª¨ë‹ˆí„°ë§ ì¤‘ì§€</button>

    <div class="status" id="status">
        <h3>ìƒíƒœ: <span id="statusText">ëŒ€ê¸° ì¤‘...</span></h3>
        <p id="positionText"></p>
        <p id="tokenText"></p>
        <p id="expiryText"></p>
    </div>

    <div class="log" id="log">
        <strong>ë¡œê·¸:</strong>
    </div>
</div>

<script>
    let eventSource = null;
    let pollingIntervalId = null;
    let currentPollingInterval = 3000; // ê¸°ë³¸ í´ë§ ê°„ê²© (3ì´ˆ)
    const API_BASE = '/api/v1/queue';

    // ëŒ€ê¸°ì—´ ì§„ì…
    async function enterQueue() {
        const concertId = document.getElementById('concertId').value;
        const userId = document.getElementById('userId').value;

        addLog('ëŒ€ê¸°ì—´ ì§„ì… ìš”ì²­ ì¤‘...', 'info');

        try {
            const response = await fetch(`${API_BASE}/enter`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ concertId, userId })
            });

            const result = await response.json();
            if (result.success) {
                addLog(`ëŒ€ê¸°ì—´ ì§„ì… ì„±ê³µ! ìˆœë²ˆ: ${result.data.position}`, 'success');
                document.getElementById('sseBtn').disabled = false;
                updateStatus(result.data);
            } else {
                addLog(`ì§„ì… ì‹¤íŒ¨: ${result.message}`, 'error');
            }
        } catch (error) {
            addLog(`ì—ëŸ¬: ${error.message}`, 'error');
        }
    }

    // SSE ì‹œì‘ (ë™ì  í´ë§ ê°„ê²© ì ìš©)
    function startSSE() {
        const concertId = document.getElementById('concertId').value;
        const userId = document.getElementById('userId').value;

        if (eventSource) {
            eventSource.close();
        }

        addLog('ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì‹œì‘...', 'info');

        eventSource = new EventSource(
            `${API_BASE}/subscribe?concertId=${concertId}&userId=${userId}`
        );

        // ìƒíƒœ ì—…ë°ì´íŠ¸ ì´ë²¤íŠ¸
        eventSource.addEventListener('status-update', (event) => {
            const data = JSON.parse(event.data);
            addLog(`ìƒíƒœ ì—…ë°ì´íŠ¸: ${data.status} (ë‹¤ìŒ í´ë§: ${data.recommendedPollIntervalMs}ms)`, 'info');
            updateStatus(data);

            // ì„œë²„ê°€ ê¶Œì¥í•˜ëŠ” í´ë§ ê°„ê²©ìœ¼ë¡œ ì¡°ì •
            if (data.recommendedPollIntervalMs && data.recommendedPollIntervalMs !== currentPollingInterval) {
                currentPollingInterval = data.recommendedPollIntervalMs;
                addLog(`í´ë§ ê°„ê²© ë³€ê²½: ${currentPollingInterval}ms`, 'info');
            }
        });

        // READY ì´ë²¤íŠ¸ (ì˜ˆë§¤ ê°€ëŠ¥)
        eventSource.addEventListener('ready', (event) => {
            const data = JSON.parse(event.data);
            addLog('ğŸ‰ ì˜ˆë§¤ í˜ì´ì§€ ì§„ì… ê°€ëŠ¥!', 'success');
            updateStatus(data);
            playNotificationSound();
            showReadyNotification();
        });

        // ì—ëŸ¬ ì´ë²¤íŠ¸
        eventSource.addEventListener('error', (event) => {
            if (event.data) {
                addLog(`ì—ëŸ¬: ${event.data}`, 'error');
            }
        });

        // ì—°ê²° ì¢…ë£Œ
        eventSource.onerror = (error) => {
            addLog('SSE ì—°ê²° ì¢…ë£Œ', 'info');
            eventSource.close();
            document.getElementById('sseBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
        };

        document.getElementById('sseBtn').disabled = true;
        document.getElementById('stopBtn').disabled = false;
    }

    // SSE ì¤‘ì§€
    function stopSSE() {
        if (eventSource) {
            eventSource.close();
            eventSource = null;
            addLog('ëª¨ë‹ˆí„°ë§ ì¤‘ì§€', 'info');
        }
        document.getElementById('sseBtn').disabled = false;
        document.getElementById('stopBtn').disabled = true;
    }

    // ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateStatus(data) {
        const statusDiv = document.getElementById('status');
        const statusText = document.getElementById('statusText');
        const positionText = document.getElementById('positionText');
        const tokenText = document.getElementById('tokenText');
        const expiryText = document.getElementById('expiryText');

        statusDiv.className = 'status ' + data.status.toLowerCase();
        statusText.textContent = getStatusText(data.status);

        if (data.position) {
            positionText.textContent = `ëŒ€ê¸° ìˆœë²ˆ: ${data.position}ë²ˆ`;
            positionText.style.display = 'block';
        } else {
            positionText.style.display = 'none';
        }

        if (data.token) {
            tokenText.textContent = `í† í°: ${data.token}`;
            tokenText.style.display = 'block';
        } else {
            tokenText.style.display = 'none';
        }

        if (data.expiredAt) {
            const expiry = new Date(data.expiredAt);
            expiryText.textContent = `ë§Œë£Œ ì‹œê°„: ${expiry.toLocaleString()}`;
            expiryText.style.display = 'block';
        } else {
            expiryText.style.display = 'none';
        }
    }

    // ìƒíƒœ í…ìŠ¤íŠ¸
    function getStatusText(status) {
        const statusMap = {
            'WAITING': 'â³ ëŒ€ê¸° ì¤‘',
            'READY': 'âœ… ì˜ˆë§¤ ê°€ëŠ¥',
            'ACTIVE': 'ğŸ¯ í™œì„±í™”ë¨',
            'EXPIRED': 'â° ë§Œë£Œë¨',
            'NOT_FOUND': 'âŒ ì—†ìŒ'
        };
        return statusMap[status] || status;
    }

    // ë¡œê·¸ ì¶”ê°€
    function addLog(message, type = 'info') {
        const logDiv = document.getElementById('log');
        const entry = document.createElement('div');
        entry.className = `log-entry ${type}`;
        const timestamp = new Date().toLocaleTimeString();
        entry.textContent = `[${timestamp}] ${message}`;
        logDiv.appendChild(entry);
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    // ì•Œë¦¼ìŒ ì¬ìƒ
    function playNotificationSound() {
        // ë¸Œë¼ìš°ì € ì•Œë¦¼ìŒ (optional)
        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBiiR1/LOeywGI3fH8NyQQAoUXrTp66hVFApGn+DyvmwhBiiR1/LOeywGI3fH8NyQQAoUXrTp66hVFApGn+DyvmwhBg==');
        audio.play().catch(() => {});
    }

    // READY ì•Œë¦¼ í‘œì‹œ
    function showReadyNotification() {
        if (Notification.permission === 'granted') {
            new Notification('ì˜ˆë§¤ ê°€ëŠ¥!', {
                body: 'ëŒ€ê¸°ì—´ ìˆœì„œê°€ ë˜ì—ˆìŠµë‹ˆë‹¤. ì˜ˆë§¤ í˜ì´ì§€ë¡œ ì´ë™í•˜ì„¸ìš”!',
                icon: 'ğŸ«'
            });
        } else if (Notification.permission !== 'denied') {
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    showReadyNotification();
                }
            });
        }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
    window.onload = () => {
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
        addLog('ëŒ€ê¸°ì—´ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ', 'success');
    };

    // í˜ì´ì§€ ì¢…ë£Œ ì‹œ SSE ì •ë¦¬
    window.onbeforeunload = () => {
        if (eventSource) {
            eventSource.close();
        }
    };
</script>
</body>
</html>
